---
import Layout from "./Layout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer";
import SiteFooter from "../components/SiteFooter";
import { resolvePageData } from "@mintlify/astro/helpers";
import type { DocsConfig } from "@mintlify/astro";
import docsConfig from "../../docs/docs.json";
import Sidebar, { MobileSidebar } from "../components/Sidebar";
import TableOfContents from "../components/TableOfContents";
import ApiOperationHeader from "../components/ApiOperationHeader";
import ApiOperationPanel from "../components/ApiOperationPanel";
import CodeBlockEnhancer from "../components/CodeBlockEnhancer";
import operations from "../generated/openapi-operations.json";
import siteMeta from "../generated/site-meta.json";
import titleMap from "../generated/title-map.json";
import pageMeta from "../generated/page-meta.json";

interface ApiOperation {
  method: string;
  path: string;
  summary: string;
  serverUrl?: string;
  responseStatus?: string;
  responseExample?: string;
  openapiRoute?: string;
}

interface PageMetaEntry {
  icon?: string;
  api?: string;
  deprecated?: boolean;
  responseStatus?: string;
  responseExample?: string;
}

interface ApiDescriptor {
  method: string;
  path: string;
}

interface Props {
  title: string;
  description?: string;
  currentPath: string;
  api?: string;
  openapiRoute?: string;
  mode?: string;
}

const { title, description, currentPath, api, openapiRoute, mode } = Astro.props;

const page = resolvePageData(docsConfig as DocsConfig, {
  currentPath,
  titleMap: titleMap as Record<string, string>
});

function normalizeApiPath(pathValue: string): string {
  const normalized = pathValue.trim().replace(/\/+$/, "");
  if (normalized === "/api") {
    return "/";
  }
  if (normalized.startsWith("/api/")) {
    return normalized.slice(4);
  }
  return normalized;
}

function unescapeApiPath(pathValue: string): string {
  return pathValue
    .replace(/\\([{}])/g, "$1")
    .replace(/\\\//g, "/")
    .trim();
}

function parseApiDescriptor(value: string | undefined): ApiDescriptor | undefined {
  if (!value) {
    return undefined;
  }
  const match = value.trim().match(/^([A-Za-z]+)\s+(.+)$/);
  if (!match) {
    return undefined;
  }
  return {
    method: match[1].toUpperCase(),
    path: unescapeApiPath(match[2])
  };
}

const operationLookup = operations as Record<string, ApiOperation>;
const pageMetaLookup = pageMeta as Record<string, PageMetaEntry>;
const apiDescriptor = parseApiDescriptor(api);
let apiOperation: ApiOperation | undefined;
const currentPageMeta = pageMetaLookup[currentPath];

if (apiDescriptor) {
  const operationKey = `${apiDescriptor.method} ${apiDescriptor.path}`.replace(/\s+/g, " ");
  apiOperation = operationLookup[operationKey];
  if (!apiOperation) {
    const targetPath = normalizeApiPath(apiDescriptor.path);
    apiOperation = Object.values(operationLookup).find((entry) => {
      return entry.method.toUpperCase() === apiDescriptor.method && normalizeApiPath(entry.path) === targetPath;
    });
  }
}

const resolvedApiOperation: ApiOperation | undefined = apiOperation
  ? {
      ...apiOperation,
      responseStatus: apiOperation.responseStatus || currentPageMeta?.responseStatus,
      responseExample: apiOperation.responseExample || currentPageMeta?.responseExample
    }
  : apiDescriptor
    ? {
        method: apiDescriptor.method,
        path: apiDescriptor.path,
        summary: title,
        responseStatus: currentPageMeta?.responseStatus,
        responseExample: currentPageMeta?.responseExample,
        openapiRoute
      }
    : undefined;
const isApiPage = Boolean(resolvedApiOperation);
const isWideModePage = mode === "wide";
const apiPlaygroundHref =
  resolvedApiOperation?.openapiRoute || openapiRoute || "/api-reference";

const primaryColor = docsConfig.colors?.primary || "#7c3aed";
const faviconHref =
  typeof docsConfig.favicon === "string"
    ? docsConfig.favicon
    : docsConfig.favicon?.light || docsConfig.favicon?.dark || "/favicon.svg";
---

<Layout title={title} description={description} faviconHref={faviconHref}>
  <div style={`--primary:${primaryColor};--color-primary:${primaryColor};`}>
    <Header
      tabs={page.tabs}
      pageTitle={title}
      groupName={page.groupName}
      siteName={siteMeta.name}
      logoHref={siteMeta.logoHref}
      logoSrc={siteMeta.logoSrc}
      navbarLinks={siteMeta.navbarLinks}
      navbarPrimary={siteMeta.navbarPrimary}
    />

    <MobileSidebar
      navigation={page.navigation}
      currentPath={currentPath}
      tabs={page.tabs || []}
      anchors={page.anchors}
      logoSrc={siteMeta.logoSrc}
      siteName={siteMeta.name}
      pageMeta={pageMeta}
      client:load
    />

    <div class="w-full px-4 pt-3 lg:pt-0">
      <div class="flex lg:gap-10 min-h-[calc(100vh-4rem)]" style="container-type: inline-size;">
        <div>
          <Sidebar navigation={page.navigation} currentPath={currentPath} anchors={page.anchors} pageMeta={pageMeta} />
        </div>

        <main class="flex-1 min-w-0 py-10" id="main-content">
          <article class="w-full">
            <header class="leading-none pb-8">
              {page.groupName && <p class="text-sm font-semibold text-(--primary) mt-0.5">{page.groupName}</p>}
              <div class="flex flex-col gap-2.5 mt-2.5">
                <h1 class="text-2xl sm:text-3xl text-gray-900 tracking-tight font-bold wrap-anywhere">{title}</h1>
                {description && (
                  <div class="text-lg prose prose-gray max-w-2xl">
                    <p>{description}</p>
                  </div>
                )}
              </div>
            </header>

            {
              isApiPage && resolvedApiOperation && (
                <ApiOperationHeader
                  method={resolvedApiOperation.method}
                  path={resolvedApiOperation.path}
                  playgroundHref={apiPlaygroundHref}
                />
              )
            }

            {
              isApiPage && resolvedApiOperation && (
                <ApiOperationPanel operation={resolvedApiOperation} variant="inline" client:load />
              )
            }

            <div class="mdx-content prose max-w-none mt-6">
              <CodeBlockEnhancer client:load />
              <slot />
              <Footer prev={page.footerPages.prev} next={page.footerPages.next} />
            </div>
          </article>
          <SiteFooter socials={siteMeta.footerSocials} />
        </main>

        {isApiPage && resolvedApiOperation ? (
          <ApiOperationPanel operation={resolvedApiOperation} variant="sidebar" client:load />
        ) : isWideModePage ? null : (
          <TableOfContents client:load />
        )}
      </div>
    </div>
  </div>
</Layout>
